---
title: "Data quality in the Secondary Care Prescription Dataset (SCMD)"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup-rmd, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r setup-r, include=FALSE}
library(tidyverse)
library(skimr)
library(bigrquery)
library(DBI)
library(dbplyr)
library(here)
library(reactable)
library(crosstalk)

source(here::here("scripts/connect_bigquery.R"))
source(here::here("scripts/sql_query_dmd.R"))
source(here::here("scripts/sql_query_scmd.R"))
```

# Description of individual datasets

## SCMD

- The SQL query below is used to get the SCMD data from Google BigQuery
- Individual analyses need to filter for specific `vmp_snomed_code`s in a subsequent query

```{r code = readLines(here('scripts/sql_query_scmd.R')), class.source = 'fold-show'}

```

### Overview of the data


```{r}
# BIG database stuff read from csv instead
# I'm not adding this to github, so needs to be run once to set up
# db_scmd <- dplyr::tbl(conn_ebm_scmd, sql_query_scmd)
# Collect data here
# df_scmd <- db_scmd %>% 
#   collect()
# Write csv do disk
# write_csv(df_scmd, here("data/scmd.csv"))

# Once the commented code above is run, we can use the local csv file
df_scmd <- read_csv(here("data/scmd.csv"),
                    col_types = cols(vmp_snomed_code = col_character()))

# create lookup table to join vmp names to codes
df_scmd_lookup <- df_scmd %>% 
  select(vmp_snomed_code, vmp_product_name) %>% 
  distinct()

# get date range for tables or in text use
scmd_date_range <- range(df_scmd$year_month)
n_ods_codes <- length(unique(df_scmd$ods_code))
n_snomed_codes <- length(unique(df_scmd$vmp_snomed_code))
sum_quantity_positive <- sum(df_scmd$total_quantity[which(df_scmd$total_quantity > 0)])
sum_quantity_negative <- sum(df_scmd$total_quantity[which(df_scmd$total_quantity < 0)])

# calculate total count for each product
df_scmd_distinct <- df_scmd %>% 
  group_by(vmp_snomed_code) %>% 
  summarise(count = sum(total_quantity, na.rm = TRUE)) %>% 
  ungroup() %>% 
  arrange(desc(count)) %>% 
  left_join(df_scmd_lookup)
```


- The date range in this notebooks is from `r scmd_date_range[[1]]` to `r scmd_date_range[[2]]`
- The SCMD dataset has *n* = `r n_ods_codes` unique ODS codes and *n* = `r n_snomed_codes` unique SNOMED codes
- The sum of all positive quantities is: `r scales::comma(sum_quantity_positive)`
- The sum of all negative quantities is: `r scales::comma(sum_quantity_negative)`

- The table below shows the first 100 entries of the SCMD dataset (arranged by `vmp_snomed_code`) from BigQuery 

```{r}

reactable(head(df_scmd, 100),
          style = list(fontSize = "12px"),
          highlight = TRUE,
          filterable = TRUE)
```





### Frequency of hospitals with data per month

```{r, fig.width=7.2, fig.height=3, cache=TRUE, fig.cap="Figure. Number of hospitals contributing monthly data."}
temp_ggplot <- df_scmd %>% 
  select(year_month, ods_code) %>% 
  distinct() %>% 
  group_by(year_month) %>% 
  count() %>% 
  ggplot(aes(x = year_month, 
             y = n)) +
  geom_line(size = 1, alpha = 0.5) +
  geom_point() +
  scale_colour_viridis_d() +
  scale_x_date(date_breaks = "4 month", 
               date_labels =  "%b %y") +
  labs(x = NULL, y = "Number of Hospitals",
       colour = NULL) +
  # geom_vline(xintercept = as.numeric(as.Date("2020-03-31")), 
             # color = "orange", 
             # linetype = 2,
             # lwd = .5, 
             # alpha = .5) +
  theme(text = element_text(size = 12))

# temp_ggplot

plotly::ggplotly(temp_ggplot,
                 tooltip = "text") %>%
  plotly::config(displayModeBar = FALSE)
```



## NHSBSA dm+d

- ADD DESCRIPTION (MILAN)

### dm+d info


```{r cache=TRUE}
db_dmd_info <- dplyr::tbl(conn_ebm_scmd, sql_query_dmd_info)
```

```{r code = readLines(here('scripts/sql_query_dmd.R')), class.source = 'fold-show'}

```


```{r cache=TRUE}
db_dmd_info_distinct <- db_dmd_info %>% 
  select(vmp_snomed_code, udfs, vtmid, form_cd, strnt_dnmtr_val, strnt_nmrtr_val, strnt_dnmtr_val, strnt_dnmtr_descr, bnf_code) %>% 
  distinct()

df_dmd_info_distinct <- db_dmd_info_distinct %>% 
  collect()

df_dmd_info_nmrt <- df_dmd_info_distinct %>% 
  drop_na(strnt_nmrtr_val) %>% 
  left_join(df_scmd_lookup) %>% 
  dplyr::relocate(vmp_product_name, vmp_snomed_code) %>% 
  arrange(vmp_snomed_code) %>% 
  mutate(vmp_product_name = fct_explicit_na(vmp_product_name)) 
  


reactable(df_dmd_info_nmrt,
          columns = list(
            udfs = reactable::colDef(show = FALSE),
            vtmid = reactable::colDef(show = FALSE),
            form_cd = reactable::colDef(show = FALSE),
            bnf_code = reactable::colDef(show = FALSE)
            ),
          style = list(fontSize = "12px"),
          highlight = TRUE,
          filterable = TRUE)
```

### ddd

```{r}

# get ddd data and make var names consistent
df_ddd <- read_csv(here("data/ddd_week492021.csv"), 
                   col_types = cols(VPID = col_character())) %>% 
  janitor::clean_names() %>% 
  rename(vmp_snomed_code = vpid)

reactable(df_ddd,
          style = list(fontSize = "12px"),
          highlight = TRUE,
          filterable = TRUE)
```

# Combined dataset

- The table below shows the total count (*'Total count'*) of each product (*'SNOMED Name and Code'*) and whether we have information about ddd (*'ddd available'*)
- You can filter the table by positive or negative count and availability of ddd (`TRUE` = "ddd info available"; `FALSE` = "product listed in dm+d dataset but no ddd info not available"; `(Missing)` = "product NOT listed in dm+d dataset, therefore no ddd info not available")

```{r}
df_ddd_avail <- df_ddd %>% 
  mutate(ddd_avail = factor(!is.na(ddd)),
         bnf_avail = factor(!is.na(bnf))) %>% 
  select(vmp_snomed_code, ddd_avail)
```


```{r}
df_scmd_tab <- df_scmd_distinct %>% 
  left_join(df_ddd_avail) %>% 
  mutate(ddd_avail = fct_explicit_na(ddd_avail)) %>% 
  select(vmp_product_name, vmp_snomed_code, count, ddd_avail) %>% 
  mutate(positive_count = factor(count >= 0, levels = c(F, T),
                                 labels = c("Negative", "Positive")))
```


```{r}

df_scmd_tab_shared <- SharedData$new(df_scmd_tab)

bscols(widths = c(3, 9),
       list(
         filter_checkbox("positive_count", "Count", 
                         df_scmd_tab_shared, ~positive_count,
                         inline = TRUE),
         filter_select("ddd_avail", "Filter ddd availability", 
                       df_scmd_tab_shared, ~ddd_avail)),
       reactable(df_scmd_tab_shared,
                 columns = list(
                   vmp_product_name = colDef(name = "Name",
                                             minWidth = 100),
                   vmp_snomed_code = colDef(name = "Code",
                                             minWidth = 50),
                   count = colDef(name = "Total count",
                                             minWidth = 30,
                                  format = colFormat(digits = 0)),
                   ddd_avail = colDef(name = "ddd available",
                                             minWidth = 30),
                   positive_count = reactable::colDef(show = FALSE)
                 ),
                 columnGroups = list(
                   colGroup(name = "SNOMED", 
                            columns = c("vmp_product_name", "vmp_snomed_code"))
                 ),
                 style = list(fontSize = "12px"),
                 highlight = TRUE,
                 filterable = TRUE,
                 defaultSorted = list(count = "desc"))) 

```

